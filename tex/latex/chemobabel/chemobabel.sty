%%
%% This is file `chemobabel.sty',
%% for generating chemical structural formulas using Open Babel and Inkscape.
%% 
%% Copyright 2014-2015 Acetaminophen (Hironobu YAMASHITA)
%%   Email   :  h.y.acetaminophen[a t]gmail.com
%%   GitHub  :  https://github.com/aminophen
%%   Blog    :  http://acetaminophen.hatenablog.com/
%%   Twitter :  @aminophen
%% 
%% This work is based on a lot of resources published online.
%%  - Noel O'Boyle http://baoilleach.blogspot.jp/
%%  - Jakob Lykke Andersen http://imada.sdu.dk/~jlandersen/
%%  - TeX Forum http://oku.edu.mie-u.ac.jp/tex/
%%
\NeedsTeXFormat{LaTeX2e}
  [1994/12/01]% LaTeX date must be December 1994 or later
\ProvidesPackage{chemobabel}
  [2015/08/29 v0.9a Chemical structures with Open Babel]

% Original source at http://imada.sdu.dk/~jlandersen/latex/graphvizObabel.sty
\RequirePackage{verbatim}
\RequirePackage{graphicx}

%% ----- Make a directory for images -----
\providecommand\chemobabelimgdir{chemobabelimgdir}
\immediate\write18{mkdir \chemobabelimgdir}

%% ----- Definition of \smilesobabel -----
\newcounter{smilesobabelCounter}
\setcounter{smilesobabelCounter}{1}
\newcommand\smilesobabelPrefix{\chemobabelimgdir/smilesobabelimg}
\newcommand\smilesobabelGetName{\smilesobabelPrefix\arabic{smilesobabelCounter}}

% 1: (optional) options for includegraphics
% 2: SMILES notation
% 3: options for obabel
\newcommand\smilesobabel[1][scale=1]{%
  \def\smilesobabel@next{\includegraphics[#1]}%
  \begingroup
  \let\do\@makeother
  \dospecials
  \catcode`\{=1
  \catcode`\}=2
  \@smilesobabel
}
\newcommand\@smilesobabel[2]{%
  \endgroup
  \immediate\write18{%
    obabel -:"#1" -O \smilesobabelGetName.svg #2 2>\smilesobabelGetName.log
    && inkscape -f \smilesobabelGetName.svg --export-pdf=\smilesobabelGetName.pdf 2>>\smilesobabelGetName.log
    || rm -f \smilesobabelGetName.pdf}%
  \IfFileExists{\smilesobabelGetName.pdf}{% the PDF exists: include it
    \smilesobabel@next{\smilesobabelGetName.pdf}%
  }{% the PDF was not created - show a warning and a hint
    \PackageWarning{chemobabel}{Processing of SMILES string failed}%
    \fbox{\begin{minipage}{0.9\textwidth}
      Warning in chemobabel: SMILES string was not processed. Remember to run \texttt{latex}
      (\texttt{pdflatex}, \texttt{platex}, etc.) with the \texttt{-shell-escape} option.\\
      \IfFileExists{\smilesobabelGetName.log}{%
        obabel log (might be empty):
        \verbatiminput{\smilesobabelGetName.log}%
      }{%
        No log file.%
      }%
    \end{minipage}}%
  }%
  \addtocounter{smilesobabelCounter}{1}% select next name
}
%% ----- Definition of \smilesobabel end -----

%% ----- Definition of \chemobabel -----
\newcounter{chemobabelCounter}
\setcounter{chemobabelCounter}{1}
\newcommand\chemobabelPrefix{\chemobabelimgdir/chemobabelimg}
\newcommand\chemobabelGetName{\chemobabelPrefix\arabic{chemobabelCounter}}

% 1: (optional) options for includegraphics
% 2: original files (.mol, .cdx, etc.)
% 3: options for obabel
\newcommand\chemobabel[1][scale=1]{%
  \def\chemobabel@next{\includegraphics[#1]}%
  \begingroup
  \let\do\@makeother
  \dospecials
  \catcode`\{=1
  \catcode`\}=2
  \@chemobabel
}
\newcommand\@chemobabel[2]{%
  \endgroup
  \IfFileExists{"#1"}{% the file exists: start processing (``#1'' can contain spaces, so ``"'' required)
    \immediate\write18{%
      obabel "#1" -O \chemobabelGetName.svg #2 2>\chemobabelGetName.log
      && inkscape -f \chemobabelGetName.svg --export-pdf=\chemobabelGetName.pdf 2>>\chemobabelGetName.log
      || rm -f \chemobabelGetName.pdf}%
    \IfFileExists{\chemobabelGetName.pdf}{% the PDF exists: include it
      \chemobabel@next{\chemobabelGetName.pdf}%
    }{% the PDF was not created - show a warning and a hint
      \PackageWarning{chemobabel}{Processing of file ``#1'' failed}%
      \fbox{\begin{minipage}{0.9\textwidth}
        Warning in chemobabel: the file was not processed. Remember to run \texttt{latex}
        (\texttt{pdflatex}, \texttt{platex}, etc.) with the \texttt{-shell-escape} option.\\
        \IfFileExists{\chemobabelGetName.log}{%
          obabel log (might be empty):
          \verbatiminput{\chemobabelGetName.log}%
        }{%
          No log file.%
        }%
      \end{minipage}}%
    }%
  }{% the file does not exist: show a std error
    \PackageError{chemobabel}{File ``#1'' not found}{}%
    \fbox{\begin{minipage}{0.9\textwidth}
      Error in chemobabel: the file ``#1'' does not exist.
    \end{minipage}}%
  }%
  \addtocounter{chemobabelCounter}{1}% select next name
}
%% ----- Definition of \chemobabel end -----

%% ----- Declaration of options (load macros for extracting \chemobabel and \smilesobabel commands) -----
\DeclareOption{extract}{%
  \PackageWarningNoLine{chemobabel}{You are using [extract] option.\MessageBreak
                                    No chemical structures will be printed}
  \input{chemobabel-extract.tex}}
\ProcessOptions
%% ----- Declaration of options end -----

\endinput

%%
%% End of file `chemobabel.sty'.
